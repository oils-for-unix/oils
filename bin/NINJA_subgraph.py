"""
bin/NINJA_subgraph.py
"""
from __future__ import print_function

from glob import glob
from fnmatch import fnmatch

from build import ninja_lib
from build.ninja_lib import log

_ = log

# TODO: should have dependencies with sh_binary
RULES_PY = 'build/ninja-rules-py.sh'


def NinjaGraph(ru):
    n = ru.n

    ru.comment('Generated by %s' % __name__)

    #
    # Files embedded in binary
    #

    n.rule('embedded-file-gen',
           command='_bin/shwrap/embedded_file_gen $in > $out',
           description='embedded_file_gen $in $out')

    # Generated by build/py.sh all -> build/doc.sh all-help
    # I wish Ninja had DIRECTORY-level dependencies?  Because this should
    # ultimately depend on doc/ref/*.md
    # We could probably create a _build/ninja-stamp/HELP file and so forth
    files = glob('_devbuild/help/*')

    # OSH and YSH stdlib
    tmp = glob('stdlib/ysh/*.ysh') + glob('stdlib/osh/*.sh')

    # Remove this?
    tmp.extend(glob('stdlib/*.ysh'))

    # exclude test files
    for path in tmp:
        if fnmatch(path, '*-test.ysh'):
            continue
        if fnmatch(path, '*-test.sh'):
            continue
        if fnmatch(path, '*/draft-*'):
            continue

        files.append(path)

    # Make sure it's DETERMINISTIC
    files.sort()

    n.build(['_gen/bin/text_files.cc'],
            'embedded-file-gen',
            files,
            implicit=['_bin/shwrap/embedded_file_gen'])
    n.newline()

    ru.cc_library('//bin/text_files', srcs=['_gen/bin/text_files.cc'])

    #
    # Programs
    #

    oils_deps = [
        '//bin/text_files',
        '//cpp/core',
        '//cpp/data_lang',
        '//cpp/fanos',
        '//cpp/libc',
        '//cpp/osh',
        '//cpp/pgen2',
        '//cpp/pylib',
        '//cpp/stdlib',
        '//cpp/frontend_flag_spec',
        '//cpp/frontend_match',
        '//cpp/frontend_pyreadline',
        '//data_lang/nil8.asdl',
        '//display/pretty.asdl',
        '//frontend/arg_types',
        '//frontend/consts',
        '//frontend/help_meta',
        '//frontend/id_kind.asdl',
        '//frontend/option.asdl',
        '//frontend/signal',
        '//frontend/syntax.asdl',
        '//frontend/types.asdl',
        '//core/optview',
        '//core/runtime.asdl',
        '//core/value.asdl',
        '//osh/arith_parse',
        '//ysh/grammar',
        '//mycpp/runtime',
    ]

    # TODO: other files should get their own
    preamble = 'bin/oils_for_unix_preamble.h'

    # Demos
    MainBinary(
        ru,
        'hello',
        preamble,
        deps=['//mycpp/runtime'],
    )
    MainBinary(ru, 'osh_eval', preamble, deps=oils_deps)
    MainBinary(ru, 'osh_parse', preamble, deps=oils_deps)

    oils_symlinks = ['osh', 'ysh']

    # Main oils-for-unix binary
    MainBinary(
        ru,
        'oils_for_unix',
        preamble,
        # _bin/cxx-opt/oils-for-unix, NOT _bin/cxx-opt/bin/oils-for-unix
        bin_path='oils-for-unix',
        symlinks=oils_symlinks,
        deps=oils_deps,
    )
    # Faster variant
    # this could have been _bin/cxx-opt/oils-for-unix.mycpp-souffle?
    MainBinary(
        ru,
        'oils_for_unix',
        preamble,
        translator='mycpp-souffle',
        bin_path='mycpp-souffle/oils-for-unix',
        symlinks=oils_symlinks,
        deps=oils_deps,
    )


_SHWRAP = {
    'mycpp': '_bin/shwrap/mycpp_main',
    'mycpp-souffle': '_bin/shwrap/mycpp_main_souffle',
}


def MainBinary(ru,
               main_name,
               preamble,
               translator='mycpp',
               bin_path=None,
               symlinks=None,
               deps=None):
    symlinks = symlinks or []
    deps = deps or []

    n = ru.n

    with open('_build/NINJA/bin.%s/translate.txt' % main_name) as f:
        deps1 = [line.strip() for line in f]

    prefix = '_gen/bin/%s.%s' % (main_name, translator)
    shwrap_path = _SHWRAP[translator]

    variables = [
        ('main_name', main_name),
        ('shwrap_path', shwrap_path),
        ('out_prefix', prefix),
        ('preamble', preamble),
    ]

    outputs = [prefix + '.cc', prefix + '.h']
    n.build(outputs,
            'gen-oils-for-unix',
            deps1,
            implicit=[shwrap_path, RULES_PY],
            variables=variables)

    ru.cc_binary(
        '_gen/bin/%s.%s.cc' % (main_name, translator),
        bin_path=bin_path,
        symlinks=symlinks,
        preprocessed=True,
        matrix=(ninja_lib.COMPILERS_VARIANTS + ninja_lib.GC_PERF_VARIANTS +
                ninja_lib.OTHER_VARIANTS),
        deps=deps)
