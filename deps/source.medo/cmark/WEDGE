# Wedge definition for cmark
#
# Loaded by deps/wedge.sh.

set -o nounset
set -o pipefail
set -o errexit

# sourced
WEDGE_NAME='cmark'
WEDGE_VERSION='0.29.0'
WEDGE_IS_ABSOLUTE=1  # TODO: try relaxing

# 2025-04: cmake broke on a Github Actions Ubuntu image due to a minor version
# upgrade.  Somehow OLD versions break (are deprecated), not new ones.

# CMake Error at CMakeLists.txt:1 (cmake_minimum_required):
#  Compatibility with CMake < 3.5 has been removed from CMake.

# Let's redo the build system in shell, so that devs and the CI don't have a
# cmake dependency.
# This code is straight C99, building and executable and shared library.

# bin/
#   cmark  # executable
# lib/
#   libcmark.so -> libcmark.so.0.29.0
# share/     # Probably don't need these two dirs
# include/

# Copied from cmark-0.29.0/src/CMakeLists.txt

# We use the same variable names as CMake
LIBRARY='libcmark'
SOVERSION=$WEDGE_VERSION

HEADERS='
  cmark.h
  parser.h
  buffer.h
  node.h
  iterator.h
  chunk.h
  references.h
  utf8.h
  scanners.h
  inlines.h
  houdini.h
  cmark_ctype.h
  render.h
'

LIBRARY_SOURCES="
  cmark.c
  node.c
  iterator.c
  blocks.c
  inlines.c
  scanners.c
  scanners.re
  utf8.c
  buffer.c
  references.c
  render.c
  man.c
  xml.c
  html.c
  commonmark.c
  latex.c
  houdini_href_e.c
  houdini_html_e.c
  houdini_html_u.c
  cmark_ctype.c
  ${HEADERS}
"

PROGRAM_SOURCES="
  ${LIBRARY_SOURCES}
  main.c
"

# Here is an example from cmark-0.29.0/build/compile_commands.json
#
# "command": "/usr/bin/cc  -I/home/andy/git/oils-for-unix/oils/_build/deps-source/cmark/cmark-0.29.0/src/. -I/home/andy/git/oils-for-unix/oils/_build/deps-source/cmark/cmark-0.29.0/build/src  -Wall -Wextra -std=c99 -pedantic -O3 -DNDEBUG -DCMARK_STATIC_DEFINE -o CMakeFiles/cmark.dir/cmark.c.o -c /home/andy/git/oils-for-unix/oils/_build/deps-source/cmark/cmark-0.29.0/src/cmark.c",
#
# So let's just copy those flags for each source, and link them into a dynamic
# library.

CC_FLAGS='-Wall -Wextra -std=c99 -pedantic -O3 -DNDEBUG -DCMARK_STATIC_DEFINE'


wedge-make() {
  local src_dir=$1
  local build_dir=$2
  local install_dir=$3

  pushd $build_dir

  if false; then
    local obj_dir=$build_dir/obj
    mkdir -v -p $obj_dir

    for c_src in $PROGRAM_SOURCES; do
      local obj=$obj_dir/$(basename $c_src).o
      cc -I "$src_dir/src" $CC_FLAGS -o $obj -c $src_dir/src/$c_src
    done
  fi

  # Note: generated re2c source is included, so we don't have to invoke it

  #-o CMakeFiles/cmark.dir/cmark.c.o -c /home/andy/git/oils-for-unix/oils/_build/deps-source/cmark/cmark-0.29.0/src/cmark.c",

  # Old build
  if true; then
    time cmake -DCMAKE_INSTALL_PREFIX=$install_dir $src_dir
    time make
  fi

  # make test

  popd
}

wedge-install() {
  local build_dir=$1

  pushd $build_dir

  time make install

  popd
}

wedge-smoke-test() {
  local install_dir=$1

  ldd $install_dir/lib/libcmark.so.$WEDGE_VERSION
}
